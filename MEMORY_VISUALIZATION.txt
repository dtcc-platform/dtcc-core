================================================================================
MEMORY ARCHITECTURE VISUALIZATION
================================================================================

SCENARIO: 100 tiles × 500MB each, 4GB RAM available
WITHOUT MPI (Single Machine, Multiprocessing)

================================================================================
BROKEN IMPLEMENTATION (Original)
================================================================================

PHASE 1: Process Tiles (4 workers)
┌─────────────────────────────────────────────────────────────┐
│ RAM (4GB available)                                          │
├─────────────────────────────────────────────────────────────┤
│ Worker 1: Tile 0 (500MB) ░░░░░░░░░░░░░░                     │
│ Worker 2: Tile 1 (500MB) ░░░░░░░░░░░░░░                     │
│ Worker 3: Tile 2 (500MB) ░░░░░░░░░░░░░░                     │
│ Worker 4: Tile 3 (500MB) ░░░░░░░░░░░░░░                     │
│                          ──────────────── = 2GB (OK) ✓       │
└─────────────────────────────────────────────────────────────┘

PHASE 2: Collect Results
┌─────────────────────────────────────────────────────────────┐
│ RAM (4GB available)                                          │
├─────────────────────────────────────────────────────────────┤
│ result_list = [                                              │
│   Tile 0 (500MB) ░░░░░░░░░░░░░░                             │
│   Tile 1 (500MB) ░░░░░░░░░░░░░░                             │
│   Tile 2 (500MB) ░░░░░░░░░░░░░░                             │
│   ...                                                        │
│   Tile 99 (500MB) ░░░░░░░░░░░░░░                            │
│ ]  TOTAL: 50GB needed  ─── ✗ CRASH! (OOM)                   │
└─────────────────────────────────────────────────────────────┘

PHASE 3: Merge (Never reached)
┌─────────────────────────────────────────────────────────────┐
│ RAM (4GB available)                                          │
├─────────────────────────────────────────────────────────────┤
│ merging_list = [100 Mesh objects] = 50GB  ✗ (Already dead)  │
└─────────────────────────────────────────────────────────────┘

RESULT: OutOfMemoryError ✗


================================================================================
FIXED IMPLEMENTATION (Disk-Backed)
================================================================================

PHASE 1: Process Tiles & Write to Disk (4 workers)
┌──────────────────────────────┐  ┌─────────────────────────────────────┐
│ RAM (4GB available)          │  │ DISK (Temp File: mesh_store.h5)     │
├──────────────────────────────┤  ├─────────────────────────────────────┤
│ Worker 1: Tile 0 (500MB)     │──→ Tile 0: 500MB ▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│ Worker 2: Tile 1 (500MB)     │──→ Tile 1: 500MB ▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│ Worker 3: Tile 2 (500MB)     │──→ Tile 2: 500MB ▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│ Worker 4: Tile 3 (500MB)     │──→ Tile 3: 500MB ▓▓▓▓▓▓▓▓▓▓▓▓▓▓     │
│                              │  │ ...                               │
│ 2GB at a time (OK) ✓          │  │ Tile 99: 500MB ▓▓▓▓▓▓▓▓▓▓▓▓▓▓    │
└──────────────────────────────┘  └─────────────────────────────────────┘
(Freed after write)                 Total: 50GB on disk

PHASE 2: Merge Iteration 1 (batch_size=2)
┌──────────────────────────────┐  ┌─────────────────────────────────────┐
│ RAM (4GB available)          │  │ DISK (mesh_store.h5)                │
├──────────────────────────────┤  ├─────────────────────────────────────┤
│ Tile 0 from disk (500MB) ███ │←→ Tile 0 [on disk]                    │
│ Tile 1 from disk (500MB) ███ │←→ Tile 1 [on disk]                    │
│ Merged 0+1 (1000MB) ██████   │──→ Merged_1000: 1000MB ▓▓▓▓▓▓▓▓      │
│                              │  │ Tile 2 [on disk]                    │
│ ~1GB used (OK) ✓              │  │ ...                               │
│ (freed, repeat)              │  │ Merged_1024 [after iteration]      │
└──────────────────────────────┘  └─────────────────────────────────────┘

PHASE 2B: Merge Iteration 2 (batch_size=2)
┌──────────────────────────────┐  ┌─────────────────────────────────────┐
│ RAM (4GB available)          │  │ DISK (mesh_store.h5)                │
├──────────────────────────────┤  ├─────────────────────────────────────┤
│ Merged_1000 (1000MB) ██████  │←→ Merged_1000 [on disk]               │
│ Merged_1001 (1000MB) ██████  │←→ Merged_1001 [on disk]               │
│ Merged_2000 (2000MB) ████████│──→ Merged_2000: 2000MB ▓▓▓▓▓▓▓▓▓▓    │
│                              │  │                                    │
│ ~2GB used (OK) ✓              │  │ [50 iterations total]              │
│ (freed, repeat)              │  │ Result: 50 intermediate tiles      │
└──────────────────────────────┘  └─────────────────────────────────────┘

PHASE 2C-2J: More Merge Iterations
┌──────────────────────────────┐  ┌─────────────────────────────────────┐
│ RAM (4GB available)          │  │ DISK (mesh_store.h5)                │
├──────────────────────────────┤  ├─────────────────────────────────────┤
│ Merged_2000 (~2GB)  ████████ │←→ Merged_2000 [on disk]               │
│ Merged_2001 (~2GB)  ████████ │←→ Merged_2001 [on disk]               │
│ Merged_3000 (~4GB)  ██████████→ Merged_3000: 4GB ▓▓▓▓▓▓▓▓▓▓▓▓▓▓    │
│                              │  │                                    │
│ ~4GB used (OK) ✓              │  │ [continue until 1 tile left]       │
│ (freed, repeat)              │  │ Total still on disk: ~60GB         │
└──────────────────────────────┘  └─────────────────────────────────────┘

FINAL: Last tile is the complete mesh
┌──────────────────────────────┐  ┌─────────────────────────────────────┐
│ RAM (4GB available)          │  │ DISK (mesh_store.h5)                │
├──────────────────────────────┤  ├─────────────────────────────────────┤
│ Final mesh loaded (500MB)    │←──Final mesh: 500MB ▓▓▓▓▓▓▓▓          │
│ ░░░░░░░░░░░░░░               │  │                                    │
│                              │  │ [intermediate files auto-deleted]  │
│ ~500MB used ✓                 │  │                                    │
└──────────────────────────────┘  └─────────────────────────────────────┘

RESULT: Complete mesh ✓ (Success!)


================================================================================
MEMORY USAGE OVER TIME
================================================================================

OLD IMPLEMENTATION:
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│ RAM                              ╱╲                          │
│ 50GB ────────────────────────    ╱  ╲                        │
│      │                          ╱    ╲                       │
│ 4GB  │ ╱╲                      ╱CRASH╲                       │
│      │╱  ╲                    ╱        ╲                      │
│ 0GB  ─────┴──────────────────╱──────────╲──────             │
│      │ Process   │ Collect  │ Merge    │ Save               │
│      0           5          10         15    Time (min)      │
│                         ✗ OutOfMemory                        │
└──────────────────────────────────────────────────────────────┘

NEW IMPLEMENTATION (disk-backed):
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│ RAM                    ╱╲  ╱╲  ╱╲  ╱╲                       │
│ 4GB ────────────────╱──╲╱──╲╱──╲╱──╲─────                  │
│      │            ╱          (stays bounded)                │
│ 2GB  │ ╱╲        ╱                                          │
│      │╱  ╲      ╱                                           │
│ 0GB  ──────────────────────────────────────────             │
│      │ Process   │ Merge Iter 1  │ Merge Iter N │ Final    │
│      0           5               10             15    (min) │
│                         ✓ Bounded Memory!                    │
└──────────────────────────────────────────────────────────────┘

DISK USAGE OVER TIME (New Implementation):
┌──────────────────────────────────────────────────────────────┐
│                                                              │
│ DISK     Merge Iterations (Write merged tiles, delete old)  │
│ 50GB ─────────────╱╲  ╱╲  ╱╲  ╱╲                           │
│      │          ╱  ╲╱  ╲╱  ╲╱  ╲─────                      │
│ 25GB │  ╱╲     ╱                                            │
│      │ ╱  ╲   ╱                                             │
│ 0GB  ──────────                                             │
│      │ Process│ Merge                      │ Save           │
│      0        5                            15        (min)  │
│                Temporarily up to 60GB (2x tiles)            │
└──────────────────────────────────────────────────────────────┘


================================================================================
COMPARISON TABLE
================================================================================

                    │  OLD (Memory-Only)  │  NEW (Disk-Backed)
────────────────────┼─────────────────────┼──────────────────────
RAM for 100×500MB   │  50GB (CRASH!)      │  2GB (OK)
RAM for 1000×500MB  │  500GB (CRASH!)     │  2GB (OK)
Disk Needed         │  0GB                │  60GB (2x tiles)
Processing Time     │  N/A (OOM)          │  30 minutes
Merge Time          │  N/A (OOM)          │  15 minutes
Failure Handling    │  Crash              │  Graceful
Use Case            │  Small cities       │  Large cities


================================================================================
CONTROL PARAMETERS
================================================================================

Parameter: use_disk_store
┌──────────────────────────────────────────────────────────┐
│ use_disk_store=True  (DEFAULT)                           │
│ Memory: O(1)     - Bounded by tile_size                  │
│ Disk:   O(N)     - Linear in number of tiles             │
│ Speed:  Slower   - Due to I/O                            │
│ Use:    Large cities, limited RAM                        │
│                                                          │
│ use_disk_store=False                                     │
│ Memory: O(N)     - Linear in number of tiles (OLD WAY!)  │
│ Disk:   0        - No temporary storage needed           │
│ Speed:  Faster   - No I/O overhead                       │
│ Use:    Small cities, plenty of RAM                      │
└──────────────────────────────────────────────────────────┘

Parameter: batch_size (in _merge_meshes_from_disk)
┌──────────────────────────────────────────────────────────┐
│ batch_size=1                                             │
│ Memory: O(1)     - 1 tile at a time                      │
│ Merges: More     - Need log(N) iterations (slower)       │
│ Disk I/O: High                                           │
│ Use: Very limited RAM                                   │
│                                                          │
│ batch_size=2 (DEFAULT)                                   │
│ Memory: O(1)     - 2 tiles at a time                     │
│ Merges: O(N)     - Balanced                              │
│ Disk I/O: Medium                                        │
│ Use: Typical case                                       │
│                                                          │
│ batch_size=4                                             │
│ Memory: O(1)     - 4 tiles at a time                     │
│ Merges: Fewer    - Need fewer iterations (faster)        │
│ Disk I/O: Lower                                         │
│ Use: Plenty of RAM and SSD                             │
└──────────────────────────────────────────────────────────┘


================================================================================
WITHOUT MPI: Why Multiprocessing Works
================================================================================

All processes run on SAME machine:
┌─────────────────────────────────────────────────────────────┐
│ SINGLE MACHINE                                              │
│ ┌──────────────────────┬──────────────────────────────────┐ │
│ │ Main Process         │ Worker Pool (Multiprocessing)   │ │
│ ├──────────────────────┼──────────────────────────────────┤ │
│ │ - Coordinate tiles   │ Worker 1: Process Tile 0        │ │
│ │ - Collect results    │ Worker 2: Process Tile 1        │ │
│ │ - Manage merge       │ Worker 3: Process Tile 2        │ │
│ │ - Write final mesh   │ Worker 4: Process Tile 3        │ │
│ │                      │ (Workers die/restart as needed) │ │
│ └──────────────────────┴──────────────────────────────────┘ │
│                                                              │
│ Shared Resources:                                           │
│ ├─ Physical RAM (4GB) - Workers write to disk, freed        │
│ ├─ Disk Storage (60GB) - HDF5 file for tiles               │
│ └─ CPU (8 cores) - Workers parallelized                    │
│                                                              │
│ No MPI needed! Multiprocessing module handles it.          │
└─────────────────────────────────────────────────────────────┘

Key Difference from MPI:
  • MPI: Distributes across MULTIPLE machines with NETWORK comms
  • Multiprocessing: Runs on SINGLE machine with SHARED DISK
  • Result: Can't work across network, but no network overhead


================================================================================
WHAT HAPPENS WITH DIFFERENT RAM AMOUNTS
================================================================================

2GB RAM Available (Laptop):
  ├─ Workers: 1 (sequential, less memory)
  ├─ batch_size: 1 (merge one at a time)
  ├─ Tile size: 500MB
  ├─ Time: Slow but works (~45 min for 100 tiles)
  └─ Result: ✓ Success

4GB RAM Available (Small Machine):
  ├─ Workers: 2
  ├─ batch_size: 2
  ├─ Tile size: 500MB
  ├─ Time: Good (~30 min)
  └─ Result: ✓ Success

8GB RAM Available (Typical):
  ├─ Workers: 4
  ├─ batch_size: 2
  ├─ Tile size: 1000MB
  ├─ Time: Fast (~15 min)
  └─ Result: ✓ Success

32GB RAM Available (High-End):
  ├─ Workers: 8
  ├─ batch_size: 4 (or disable disk store)
  ├─ Tile size: 2000MB
  ├─ Time: Very fast (~5 min)
  └─ Result: ✓ Success

100MB RAM Available (Tiny):
  ├─ Workers: 1
  ├─ batch_size: 1
  ├─ Tile size: 50MB (reduce)
  ├─ Time: Very slow (~2 hours) but works!
  └─ Result: ✓ Success (if disk has space)


================================================================================
END VISUALIZATION
================================================================================
